name: ü™ü Windows x64 Only

on:
  workflow_dispatch: # Manual trigger only

permissions:
  contents: write

jobs:
  windows-build:
    runs-on: windows-latest
    name: Build Windows x64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install app dependencies
        run: npm install

      - name: Create Windows app icons
        run: |
          if (Test-Path "src-tauri/icons/icon.png") {
            Write-Host "‚úÖ Found icon.png"
            # Try to create ICO, fallback to copy if fails
            try {
              magick src-tauri/icons/icon.png -resize 256x256 src-tauri/icons/icon.ico
              Write-Host "‚úÖ Created icon.ico with ImageMagick"
            } catch {
              Copy-Item src-tauri/icons/icon.png src-tauri/icons/icon.ico
              Write-Host "‚ö†Ô∏è ImageMagick failed, copied PNG as ICO"
            }
          } else {
            Write-Host "‚ùå icon.png not found"
            Get-ChildItem src-tauri/icons/ -ErrorAction SilentlyContinue
          }
        shell: powershell

      - name: Build Windows application
        run: npm run tauri:build -- --target x86_64-pc-windows-msvc

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: videoplayer-windows-x64-only
          path: |
            src-tauri/target/x86_64-pc-windows-msvc/release/bundle/**/*
          retention-days: 30

      - name: Build Summary
        run: |
          Write-Host "üéâ Windows build completed!"
          Write-Host "üì¶ Download: videoplayer-windows-x64-only"
          Write-Host "üìÅ Contains: .msi and .exe installers"
        shell: powershell